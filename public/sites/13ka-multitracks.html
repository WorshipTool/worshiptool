<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Multitrack nahrávky</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f0f0f0;
                margin: 0;
                padding: 20px;
            }
            h1 {
                text-align: center;
                color: #333;
            }
            h4 {
                margin-bottom: 0px;
            }
            .gdrive-load {
                display: inline-block;
                font-size: 16px;
                margin-right: 50px;
            }
            #songInput {
                display: inline-block;
                margin: 20px auto;
                padding: 10px;
                font-size: 16px;
            }
            #songList {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
                margin-top: 20px;
            }
            .song-select {
                font-size: 20px;
                padding: 5px;
                width: 400px;
            }
            .song-button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 15px 20px;
                font-size: 16px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            .song-button:hover {
                background-color: #0056b3;
            }
            #trackControls {
                margin-top: 30px;
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .track-container {
                display: flex;
                align-items: center;
                /* margin-bottom: 20px; */
                padding: 5px 15px;
                border-bottom: 1px solid #ccc;
            }
            .track-label {
                flex: 2;
                font-weight: bold;
                color: #333;
            }
            .track-label.loading::after {
                content: " ";
                width: 15px;
                display: inline-block;
                height: 15px;
                margin-left: 15px;
                background-size: contain;
                background-image: url("data:image/gif;base64,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");
            }
            .track-label.error::after {
                content: "X";
                width: 15px;
                display: inline-block;
                height: 15px;
                margin-left: 15px;
                color: #cc0000;
            }
            .play-button,
            .stop-button {
                background-color: #28a745;
                color: white;
                border: none;
                padding: 10px;
                margin-right: 10px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            .play-button:hover,
            .stop-button:hover {
                background-color: #218838;
            }
            .volume-control {
                margin-left: 15px;
                flex: 1;
            }
            .progress-bar {
                flex: 2;
                margin: 0 15px;
            }
            .main-progress-bar {
                width: 500px;
                margin-left: 20px;
            }
            .error-label {
                text-align: center;
                color: #cc0000;
                margin: 0;
            }
            .play-all-button,
            .stop-all-button {
                width: 150px;
            }
            .play-all-button,
            .stop-all-button {
                display: inline-block;
                margin: 20px;
                background-color: #ff5722;
                color: white;
                border: none;
                padding: 15px 20px;
                font-size: 18px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            .play-all-button:hover {
                background-color: #e64a19;
            }
            .play-all-button[disabled] {
                cursor: not-allowed;
                opacity: 0.7;
            }
            .play-all-button {
                background-color: #28a745;
            }
            .play-all-button:hover {
                background-color: #218838;
            }
            .mute-button,
            .solo-button {
                margin-right: 10px;
                height: 40px;
                padding-left: 10px;
                padding-right: 10px;
            }
            .mute-button {
                background-color: #501c1a;
                color: white;
            }
            .mute-button.muted {
                background-color: #e93323;
            }
            .solo-button {
                background-color: #41310e;
                color: white;
            }
            .solo-button.soloed {
                background-color: #e4d747;
                color: black;
            }
            @media (max-width: 991px) {
                .play-all-button,
                .stop-all-button {
                    width: 100px;
                }
                .progress-label,
                .progress-bar {
                    display: none;
                }
                .main-progress-bar {
                    width: calc(100% - 320px);
                }
            }
            @media (max-width: 767px) {
                body {
                    padding-left: 0;
                    padding-right: 0;
                }
                #trackControls {
                    padding: 20px 0;
                }
                .song-select {
                    width: calc(100% - 30px);
                }
                .play-all-button,
                .stop-all-button {
                    width: calc((100% / 2) - 40px);
                }
                .main-progress-bar {
                    width: calc(100% - 40px);
                }
                .progress-label,
                .progress-bar {
                    display: none;
                }
                .track-container {
                    display: block;
                }
                .track-label {
                    display: inline-block;
                    text-align: center;
                    margin: 10px;
                    width: calc(100% - 145px);
                }
                .volume-control {
                    width: calc(100% - 100px);
                    transform: translateY(4px);
                }
            }
        </style>
    </head>
    <body>
        <h1>Multitrack nahrávky</h1>
        <div style="display: none">
            <h4 for="songInput">Nahrajte složku s písněmi:</h4>
            <button class="gdrive-load" onclick="listFiles()">
                Načíst z Google Drive
            </button>
            <input type="file" id="songInput" webkitdirectory multiple />
        </div>
        <div id="songList"></div>
        <div id="trackControls"></div>
        <script>
            try {
                window.AudioContext =
                    window.AudioContext || window.webkitAudioContext;
                window.audioContext = new window.AudioContext();
            } catch (e) {
                console.error("No Web Audio API support");
            }

            let startedAt, pausedAt;
            let playing = false;
            let globalProgressBarFocused = false;

            /*
             * WebAudioAPISoundManager Constructor
             */
            var WebAudioAPISoundManager = function (context) {
                this.context = context;
                this.bufferList = {};
                this.progressBarList = {};
                this.playingSounds = {};
            };

            /*
             * WebAudioAPISoundManager Prototype
             */
            WebAudioAPISoundManager.prototype = {
                addSound: function (url, callback, errorCallback, progressBar) {
                    // Load buffer asynchronously
                    var request = new XMLHttpRequest();
                    request.open("GET", url, true);
                    request.responseType = "arraybuffer";

                    var self = this;

                    function error() {
                        //zkusime proxy server
                        var request2 = new XMLHttpRequest();
                        let url2 = proxyPrefixPublic + encodeURIComponent(url);
                        request2.open("GET", url2, true);
                        request2.responseType = "arraybuffer";

                        request2.onload = function () {
                            // Asynchronously decode the audio file data in request.response
                            self.context.decodeAudioData(
                                request2.response,

                                function (buffer) {
                                    if (!buffer) {
                                        alert(
                                            "error decoding file data: " + url
                                        );
                                        return;
                                    }
                                    self.bufferList[url] = buffer;
                                    self.progressBarList[url] = progressBar;
                                }
                            );

                            if (callback) {
                                callback();
                            }
                        };
                        request2.onerror = function () {
                            if (errorCallback) {
                                errorCallback();
                            }
                            console.error("BufferLoader: XHR error");
                        };
                        request2.send();
                    }

                    request.onload = function () {
                        if (request.status === 403) {
                            error();
                            return;
                        }
                        // Asynchronously decode the audio file data in request.response
                        self.context.decodeAudioData(
                            request.response,

                            function (buffer) {
                                if (!buffer) {
                                    alert("error decoding file data: " + url);
                                    return;
                                }
                                self.bufferList[url] = buffer;
                                self.progressBarList[url] = progressBar;
                            }
                        );

                        if (callback) {
                            callback();
                        }
                    };

                    request.onerror = function () {
                        error();
                    };

                    request.send();
                },
                stopSoundWithUrl: function (url) {
                    if (this.playingSounds.hasOwnProperty(url)) {
                        for (var i in this.playingSounds[url]) {
                            if (
                                i == "source" &&
                                this.playingSounds[url].hasOwnProperty(i)
                            )
                                this.playingSounds[url][i].stop();
                        }
                    }
                }
            };

            /*
             * WebAudioAPISound Constructor
             */
            var WebAudioAPISound = function (
                url,
                options,
                callback,
                errorCallback,
                progressBar
            ) {
                this.settings = {
                    loop: false
                };
                this.volume = 1;

                for (var i in options) {
                    if (options.hasOwnProperty(i))
                        this.settings[i] = options[i];
                }

                this.url = url;
                window.webAudioAPISoundManager =
                    window.webAudioAPISoundManager ||
                    new WebAudioAPISoundManager(window.audioContext);
                this.manager = window.webAudioAPISoundManager;
                this.manager.addSound(
                    url,
                    callback,
                    errorCallback,
                    progressBar
                );
            };

            /*
             * WebAudioAPISound Prototype
             */
            WebAudioAPISound.prototype = {
                play: function (percentage, index) {
                    var buffer = this.manager.bufferList[this.url];
                    if (typeof buffer !== "undefined") {
                        var sourceObj = this.makeSource(buffer);
                        sourceObj.source.loop = this.settings.loop;
                        if (
                            percentage !== null &&
                            typeof percentage !== "undefined"
                        ) {
                            if (playing) {
                                this.stop();
                            }
                            let duration = buffer.duration * 1000;
                            startedAt =
                                Date.now() - (duration * percentage) / 100;
                            sourceObj.source.start(
                                0,
                                (duration * percentage) / 100 / 1000
                            );
                            playAllButton.textContent = "Pauza";
                        } else if (pausedAt) {
                            startedAt = Date.now() - pausedAt;
                            sourceObj.source.start(0, pausedAt / 1000);
                        } else {
                            startedAt = Date.now();
                            sourceObj.source.start();
                        }
                        playing = true;
                        let updateProgress = () => {
                            if (playing) {
                                setTimeout(() => {
                                    if (playing) {
                                        let elapsed = Date.now() - startedAt;
                                        let duration = buffer.duration * 1000;
                                        if (elapsed > duration) {
                                            audioElements.forEach(
                                                ({ audio }) => {
                                                    audio.stop();
                                                }
                                            );
                                            playAllButton.textContent =
                                                "Přehrát";
                                        } else {
                                            let progressBar =
                                                this.manager.progressBarList[
                                                    this.url
                                                ];
                                            const isFirst = index === 0;
                                            if (
                                                isFirst &&
                                                !globalProgressBarFocused
                                            ) {
                                                globalProgressBar.value =
                                                    (elapsed / duration) * 100;
                                            }
                                            if (progressBar) {
                                                progressBar.value =
                                                    (elapsed / duration) * 100;
                                            }
                                            updateProgress();
                                        }
                                    }
                                }, 250);
                            }
                        };
                        updateProgress();

                        if (
                            !this.manager.playingSounds.hasOwnProperty(this.url)
                        ) {
                            this.manager.playingSounds[this.url] = {};
                        }
                        this.manager.playingSounds[this.url].source =
                            sourceObj.source;
                        this.manager.playingSounds[this.url].gain =
                            sourceObj.gainNode;
                    }
                },
                pause: function () {
                    this.manager.stopSoundWithUrl(this.url);
                    pausedAt = Date.now() - startedAt;
                    playing = false;
                },
                stop: function () {
                    this.manager.stopSoundWithUrl(this.url);
                    pausedAt = null;
                    playing = false;
                    globalProgressBar.value = 0;
                    this.manager.progressBarList[this.url].value = 0;
                },
                getVolume: function () {
                    return this.translateVolume(this.volume, true);
                },
                //Expect to receive in range 0-100
                setVolume: function (volume) {
                    this.volume = this.translateVolume(volume);
                    this.manager.playingSounds[this.url].gain.gain.value =
                        volume / 100;
                },
                translateVolume: function (volume, inverse) {
                    return inverse ? volume * 100 : volume / 100;
                },
                makeSource: function (buffer) {
                    var source = this.manager.context.createBufferSource();
                    var gainNode = this.manager.context.createGain();
                    gainNode.gain.value = this.volume;
                    source.buffer = buffer;
                    source.connect(gainNode);
                    gainNode.connect(this.manager.context.destination);
                    return { source, gainNode };
                }
            };

            const FOLDER_ID = "1qy8Is05siyYqgQeIAYDnz7f8hPmJALra";
            const API_KEY = "AIzaSyAIPuE_P76vWJT7ogosN5CgDpPURBc_Exk";
            const proxyPrefixPublic = "https://corsproxy.io/?";

            function getBrowserName() {
                if (
                    (navigator.userAgent.indexOf("Opera") ||
                        navigator.userAgent.indexOf("OPR")) != -1
                ) {
                    return "Opera";
                } else if (navigator.userAgent.indexOf("Edg") != -1) {
                    return "Edge";
                } else if (navigator.userAgent.indexOf("Chrome") != -1) {
                    return "Chrome";
                } else if (navigator.userAgent.indexOf("Safari") != -1) {
                    return "Safari";
                } else if (navigator.userAgent.indexOf("Firefox") != -1) {
                    return "Firefox";
                } else if (
                    navigator.userAgent.indexOf("MSIE") != -1 ||
                    !!document.documentMode == true
                ) {
                    return "IE";
                } else {
                    return "unknown";
                }
            }
            function isOnMobile() {
                let check = false;
                (function (a) {
                    if (
                        /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(
                            a
                        ) ||
                        /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(
                            a.substr(0, 4)
                        )
                    )
                        check = true;
                })(navigator.userAgent || navigator.vendor || window.opera);
                return check;
            }
            const onMobile = isOnMobile();
            const browser = getBrowserName();

            const loadingImg =
                "data:image/gif;base64,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";
            const songInput = document.getElementById("songInput");
            const songList = document.getElementById("songList");
            const trackControls = document.getElementById("trackControls");
            const errorLabel = document.createElement("h2");
            errorLabel.className = "error-label";
            const playAllButton = document.createElement("button");
            const stopAllButton = document.createElement("button");
            const globalProgressBar = document.createElement("input");
            globalProgressBar.type = "range";
            globalProgressBar.min = 0;
            globalProgressBar.max = 100;
            globalProgressBar.value = 0;
            globalProgressBar.step = "any";
            globalProgressBar.className = "main-progress-bar";

            globalProgressBar.addEventListener("mousedown", (event) => {
                globalProgressBarFocused = true;
            });
            globalProgressBar.addEventListener("mouseup", (event) => {
                globalProgressBarFocused = false;
                let value = event.target.value;
                audioElements.forEach(({ audio }, index) => {
                    audio.play(value, index);
                });
            });
            globalProgressBar.addEventListener("touchstart", (event) => {
                globalProgressBarFocused = true;
            });
            globalProgressBar.addEventListener("touchend", (event) => {
                globalProgressBarFocused = false;
                let value = event.target.value;
                audioElements.forEach(({ audio }, index) => {
                    audio.play(value, index);
                });
            });
            let audioElements = [];

            function listFiles() {
                songList.innerHTML = `<img src=${loadingImg} />`;
                const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&key=${API_KEY}`; // Public access query, no need for key
                fetch(url)
                    .then((response) => response.json())
                    .then((data) => {
                        const files = data.files;
                        if (files && files.length > 0) {
                            displaySongList(files);
                        } else {
                            console.error("No files found.");
                        }
                    })
                    .catch((error) =>
                        console.error("Error fetching files:", error)
                    );
            }

            function displaySongList(folders) {
                songList.innerHTML = ""; // Clear previous songs
                trackControls.innerHTML = ""; // Clear previous controls

                let values = [];

                let songSelect = document.createElement("select");
                songSelect.className = "song-select";
                songSelect.addEventListener("change", (e) => {
                    if (e.target.value !== "") {
                        audioElements.forEach(({ audio }) => {
                            audio.stop();
                        });
                        playAllButton.textContent = "Přehrát";
                        loadTracksFromDrive(null, e.target.value);
                    }
                });
                const nullOption = document.createElement("option");
                nullOption.textContent = "--- Vyber skladbu ---";
                nullOption.value = "";
                songSelect.appendChild(nullOption);
                folders.sort((a, b) => {
                    return a.name.localeCompare(b.name);
                });
                folders.forEach((folder) => {
                    const songOption = document.createElement("option");
                    songOption.value = folder.id;
                    songOption.textContent = folder.name;
                    songSelect.appendChild(songOption);
                    return;
                    const songButton = document.createElement("button");
                    songButton.textContent = folder.name;
                    songButton.className = "song-button";
                    songButton.addEventListener("click", () => {
                        if (folder.tracks) {
                            loadTracks(folder.tracks);
                        } else {
                            loadTracksFromDrive(folder);
                        }
                    });
                    songList.appendChild(songButton);
                });

                songList.appendChild(songSelect);
            }

            function fetchTracks(tracks) {
                tracks.forEach((trackFile, index) => {
                    let url = `https://www.googleapis.com/drive/v3/files/${trackFile.id}?alt=media&key=${API_KEY}`;
                    // url = proxyPrefixPublic + encodeURIComponent(url);
                    fetch(url, { referrer: "https://milost-hradec.cz" })
                        .then(async (response) => {
                            if (response.ok) {
                                const data = await response.arrayBuffer();
                                const blob = new Blob([data], {
                                    type: "audio/mpeg"
                                });
                                const blobUrl = URL.createObjectURL(blob);
                                audioElements[index].audio.src = blobUrl;
                                audioElements[index].trackLabel.className =
                                    "track-label";
                            } else {
                                audioElements[index].trackLabel.className =
                                    "track-label error";
                                errorLabel.textContent =
                                    "Chyba načtení, zkus to později";
                                errorLabel.margin = "20px 0";
                            }
                        })
                        .catch((err) => {
                            //cors error pokud failne request
                            let proxyUrl =
                                proxyPrefixPublic + encodeURIComponent(url);
                            //zkusim to jeste jednou pres proxy
                            fetch(proxyUrl, {
                                referrer: "https://milost-hradec.cz"
                            }).then(async (response) => {
                                if (response.ok) {
                                    const data = await response.arrayBuffer();
                                    const blob = new Blob([data], {
                                        type: "audio/mpeg"
                                    });
                                    const blobUrl = URL.createObjectURL(blob);
                                    audioElements[index].audio.src = blobUrl;
                                    audioElements[index].trackLabel.className =
                                        "track-label";
                                } else {
                                    audioElements[index].trackLabel.className =
                                        "track-label error";
                                    errorLabel.textContent =
                                        "Chyba načtení, zkus to později";
                                    errorLabel.margin = "20px 0";
                                }
                            });
                        });
                });
            }

            async function loadTracks(tracks, fromGoogle = false) {
                trackControls.innerHTML = ""; // Vymazání předchozích ovládacích prvků
                audioElements = []; // Vymazání předchozích zvukových prvků

                trackControls.appendChild(errorLabel);
                trackControls.appendChild(playAllButton);
                trackControls.appendChild(stopAllButton);
                trackControls.appendChild(globalProgressBar);

                let noProxy = false;
                let fetched = null;
                fetched = tracks.map((trackFile) => {
                    let url = fromGoogle
                        ? `https://www.googleapis.com/drive/v3/files/${trackFile.id}?alt=media&key=${API_KEY}`
                        : URL.createObjectURL(trackFile);
                    return url;
                });

                tracks.forEach((trackFile, index) => {
                    if (!trackFile.name.endsWith("mp3")) {
                        return;
                    }
                    const trackLabel = document.createElement("span");
                    const progressBar = document.createElement("input");
                    let audioElement = new WebAudioAPISound(
                        fetched[index],
                        {},
                        () => {
                            trackLabel.className = "track-label";
                            if (
                                document.getElementsByClassName(
                                    "track-label loading"
                                ).length === 0
                            ) {
                                playAllButton.disabled = false;
                            }
                        },
                        () => {
                            trackLabel.className = "track-label error";
                            errorLabel.textContent =
                                "Chyba načtení, zkus to později";
                            errorLabel.margin = "20px 0";
                        },
                        progressBar
                    );
                    const volumeControl = document.createElement("input");
                    const muteButton = document.createElement("button");
                    const soloButton = document.createElement("button");
                    const progressLabel = document.createElement("span");
                    const trackContainer = document.createElement("div");

                    trackContainer.className = "track-container";
                    trackLabel.className = "track-label";
                    trackLabel.textContent = trackFile.name;
                    if (fromGoogle) {
                        trackLabel.className = "track-label loading";
                    }

                    progressLabel.className = "progress-label";
                    progressLabel.textContent = "Progress:";

                    volumeControl.type = "range";
                    volumeControl.min = 0;
                    volumeControl.max = 1;
                    volumeControl.step = 0.01;
                    volumeControl.value = 1;
                    volumeControl.className = "volume-control";

                    volumeControl.addEventListener("input", () => {
                        audioElement.setVolume(volumeControl.value * 100);
                    });

                    muteButton.textContent = "Mute";
                    muteButton.className = "mute-button";
                    soloButton.textContent = "Solo";
                    soloButton.className = "solo-button";

                    muteButton.addEventListener("click", () => {
                        if (muteButton.className.includes("muted")) {
                            if (
                                soloButton.className.includes("soloed") ||
                                !audioElements.some((element) =>
                                    element.soloBtn.className.includes("soloed")
                                )
                            ) {
                                audioElement.setVolume(
                                    audioElement.previousVolume
                                );
                            }
                            muteButton.className = "mute-button";
                        } else {
                            if (
                                audioElement.previousVolume == null ||
                                typeof audioElement.previousVolume ==
                                    "undefined"
                            ) {
                                audioElement.previousVolume =
                                    audioElement.volume * 100;
                            }
                            audioElement.setVolume(0);
                            muteButton.className = "mute-button muted";
                        }
                    });

                    soloButton.addEventListener("click", () => {
                        soloButton.className = soloButton.className.includes(
                            "soloed"
                        )
                            ? "solo-button"
                            : "solo-button soloed";
                        let soloEnabled = audioElements.some((element) =>
                            element.soloBtn.className.includes("soloed")
                        );
                        audioElements.forEach(({ audio }) => {
                            if (
                                audio.previousVolume == null ||
                                typeof audio.previousVolume == "undefined"
                            ) {
                                audio.previousVolume = audio.volume * 100;
                            }
                        });
                        if (soloEnabled) {
                            audioElements.forEach(
                                ({ audio, name, soloBtn, muteBtn }) => {
                                    if (
                                        soloBtn.className.includes("soloed") &&
                                        !muteBtn.className.includes("muted")
                                    ) {
                                        audio.setVolume(audio.previousVolume);
                                    } else if (
                                        !muteBtn.className.includes("muted")
                                    ) {
                                        audio.setVolume(0);
                                    }
                                }
                            );
                        } else {
                            audioElements.forEach(
                                ({ audio, name, soloBtn, muteBtn }) => {
                                    if (name !== trackFile.name) {
                                        if (
                                            !muteBtn.className.includes("muted")
                                        ) {
                                            audio.setVolume(
                                                audio.previousVolume
                                            );
                                        }
                                    }
                                }
                            );
                        }
                    });

                    progressBar.type = "range";
                    progressBar.min = 0;
                    progressBar.max = 100;
                    progressBar.value = 0;
                    progressBar.step = "any";
                    progressBar.className = "progress-bar";
                    progressBar.disabled = true;

                    trackContainer.appendChild(muteButton);
                    trackContainer.appendChild(soloButton);
                    trackContainer.appendChild(trackLabel);
                    trackContainer.appendChild(progressLabel);
                    trackContainer.appendChild(progressBar);
                    trackContainer.appendChild(
                        document.createTextNode(" Hlasitost: ")
                    );
                    trackContainer.appendChild(volumeControl);
                    trackControls.appendChild(trackContainer);

                    audioElements.push({
                        audio: audioElement,
                        trackLabel,
                        volumeControl: volumeControl,
                        name: trackFile.name,
                        soloBtn: soloButton,
                        muteBtn: muteButton
                    });
                });

                if (fromGoogle) {
                    playAllButton.disabled = true;
                }
            }

            function loadTracksFromDrive(folder, folderId) {
                if (!folderId) {
                    folderId = folder.id;
                }
                trackControls.innerHTML = `<img src=${loadingImg} />`;
                const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${API_KEY}`; // Public access query, no need for key
                fetch(url)
                    .then((response) => response.json())
                    .then((data) => {
                        const files = data.files;
                        if (files && files.length > 0) {
                            Promise.all(
                                files.map((file) => {
                                    return new Promise((resolve, reject) => {
                                        const url2 =
                                            "https://www.googleapis.com/drive/v3/files/" +
                                            file.id +
                                            `?fields=webViewLink&key=${API_KEY}`;
                                        fetch(url2)
                                            .then((response) => response.json())
                                            .then((data) => {
                                                resolve({
                                                    ...file,
                                                    contentLink:
                                                        data.webViewLink
                                                });
                                            });
                                    });
                                })
                            ).then((values) => {
                                loadTracks(values, true);
                            });
                        } else {
                            console.error("No files found.");
                        }
                    })
                    .catch((error) =>
                        console.error("Error fetching files:", error)
                    );
            }

            document.addEventListener("DOMContentLoaded", () => {
                playAllButton.textContent = "Přehrát";
                playAllButton.className = "play-all-button";
                stopAllButton.textContent = "Zastavit";
                stopAllButton.classList = "stop-all-button";

                songInput.addEventListener("change", (event) => {
                    const files = Array.from(event.target.files);
                    const songFolders = [];

                    // Roztřídit soubory podle složek (písní)
                    files.forEach((file) => {
                        const folderName =
                            file.webkitRelativePath.split("/")[1];
                        let folderIndex = songFolders.findIndex(
                            (folder) => folder.name == folderName
                        );
                        if (folderIndex == -1) {
                            songFolders.push({ name: folderName, tracks: [] });
                            folderIndex = songFolders.length - 1;
                        }
                        songFolders[folderIndex].tracks.push(file);
                    });

                    displaySongList(songFolders);
                });

                playAllButton.addEventListener("click", () => {
                    if (playAllButton.textContent == "Přehrát") {
                        audioElements.forEach(({ audio }, index) => {
                            audio.play(null, index);
                        });
                        playAllButton.textContent = "Pauza";
                    } else {
                        audioElements.forEach(({ audio }) => {
                            audio.pause();
                        });
                        playAllButton.textContent = "Přehrát";
                    }
                });

                stopAllButton.addEventListener("click", () => {
                    audioElements.forEach(({ audio }) => {
                        audio.stop();
                    });
                    playAllButton.textContent = "Přehrát";
                });

                listFiles();
            });
        </script>
    </body>
</html>
